# Balance Service

**Описание:**

Это микросервис для управления балансами пользователей, предоставляющий ряд функций, такие как начисление средств, резервирование, и учет выручки. Для запуска и использования сервиса следуйте инструкциям ниже.

## Запуск

Для запуска сервиса выполните следующие команды:

1. Запустите контейнеры с помощью Docker Compose:
   ```
   docker compose up
   ```

2. Примените миграции базы данных:
   ```
   make migrate
   ```

3. Запустите сервис:
   ```
   make run
   ```

**Примечание:** Перед началом использования, необходимо создать пользователя в базе данных.

## Тестирование

Для запуска тестов выполните следующую команду:
```
go test ./...
```

Тесты написаны для проверки конкурентной записи резервирования и должны быть запущены параллельно с выполнением программы.

## Документация Swagger

Для получения дополнительной информации о доступных эндпоинтах и их использовании, посетите [Swagger-документацию](http://localhost:8080/swagger/index.html#/).

## Работающие эндпоинты

### GET http://localhost:8080/api/v1/balance/1
Возвращает баланс пользователя с идентификатором 1.

### POST http://localhost:8080/api/v1/balance/credit
Начисляет средства на баланс пользователя. Принимает идентификатор пользователя и сумму начисления в формате JSON:
```json
{
    "id": 1,
    "amount": 200
}
```

### POST http://localhost:8080/api/v1/balance/reserve
Резервирует средства, уменьшая баланс пользователя и создавая запись в таблице резервирования. Принимает идентификатор пользователя, идентификатор услуги, идентификатор заказа и стоимость в формате JSON:
```json
{
    "user_id": 1,
    "service_id": 1,
    "order_id": 1,
    "amount": 100
}
```
**Примечание:** Для одного пользователя нельзя создать повторно резервирование на одну и ту же услугу. Работает constraint user_id_service_id

### POST http://localhost:8080/api/v1/balance/revenue
Списывает средства с резервирования и создает запись о выручке. Запись остается в таблице резервирования с суммой 0 и значением recognized_at, указывающим на признание резервирования. Принимает идентификатор пользователя, идентификатор услуги, идентификатор заказа и стоимость в формате JSON:
```json
{
    "user_id": 1,
    "service_id": 1,
    "order_id": 1,
    "amount": 100
}
```

### GET http://localhost:8080/api/v1/report
Выводит все записи из таблицы отчета о выручке, отсортированные по пользователям.

### Автоматическая отмена не признанных резервирований
Cервис включает в себя механизм автоматической отмены резервирований, которые не были признаны в течение 5 минут после их создания. Механизм выполняется каждую минуту.

Если резервирование было создано более 5 минут назад и не было признано, оно автоматически отменяется.

Приятного использования!